resource "kubernetes_namespace" "cve-consumer" {
  metadata {
    annotations = {
      name = "cve-consumer"
    }
    labels = {
      name            = "cve-consumer"
      istio-injection = "enabled"
    }
    name = "cve-consumer"
  }
}

resource "helm_release" "cve-consumer" {
  depends_on = [kubernetes_namespace.cve-consumer]

  name       = "webapp-cve-consumer"
  repository = "git+ssh://git@github.com/csye7125-su24-team08/helm-webapp-cve-consumer.git"
  chart      = "helm-webapp-cve-consumer" # Relative path to the chart directory in the repo

  create_namespace = true
  namespace        = "cve-consumer"

  values = ["${file("./cve-consumer/cve-consumer-values.yaml")}"]

  set {
    name  = "imagePullSecrets.dockerConfig"
    value = var.dockerCreds
  }

  set {
    name  = "db_secrets.openai_api_key"
    value = var.openai_api_key
  }

  set {
    name  = "db_secrets.flyway.password"
    value = base64encode(var.postgresPassword)
  }

  set {
    name  = "configMap.flyway.username"
    value = var.postgresUser
  }

}
